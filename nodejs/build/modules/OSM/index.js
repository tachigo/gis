'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _axios = _interopRequireDefault(require("axios"));

var _xmlJs = _interopRequireDefault(require("xml-js"));

var _Utils = _interopRequireDefault(require("./../Utils"));

var _CountryTree = _interopRequireDefault(require("./CountryTree"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class OSM {
  static getCountryTree() {
    return _CountryTree.default;
  }

  static async relationFull(osmIds) {
    const relations = {};

    for await (const osmId of osmIds) {
      await _Utils.default.log(`https://www.openstreetmap.org/api/0.6/relation/${osmId}/full`);
      relations[osmId] = await this.api.get(`/relation/${osmId}/full`).then(res => {
        const xml = res.data;
        return _xmlJs.default.xml2js(xml, {
          compact: true
        });
      });
    }

    return relations;
  }

  static async relationWays(osmId, osmXmlObj) {
    const nodeList = osmXmlObj['osm']['node'];
    const nodes = {};

    for await (const node of nodeList) {
      const attr = node['_attributes'];
      const lat = +attr['lat'];
      const lon = +attr['lon'];
      const nodeId = +attr['id'];

      if (!nodes[nodeId]) {
        nodes[nodeId] = {
          lat,
          lon
        };
      }
    }

    let wayList;

    if (Array.isArray(osmXmlObj['osm']['way'])) {
      wayList = osmXmlObj['osm']['way'];
    } else {
      wayList = [osmXmlObj['osm']['way']];
    }

    const ways = {};

    for await (const way of wayList) {
      const attr = way['_attributes'];
      const wayId = +attr['id'];
      const nds = way['nd'];
      const lineString = [];

      for await (const nd of nds) {
        const ndId = nd['_attributes']['ref'];
        const node = nodes[ndId] || {};

        if (node) {
          lineString.push([node.lon, node.lat]);
        }
      }

      ways[wayId] = {
        type: 'LineString',
        coordinates: lineString
      };
    }

    const result = [];
    let relationList;

    if (Array.isArray(osmXmlObj['osm']['relation'])) {
      relationList = osmXmlObj['osm']['relation'];
    } else {
      relationList = [osmXmlObj['osm']['relation']];
    }

    for await (const relation of relationList) {
      const attr = relation['_attributes'];
      const relationId = +attr['id'];

      if (relationId === +osmId) {
        let memberList;

        if (Array.isArray(relation['member'])) {
          memberList = relation['member'];
        } else {
          memberList = [relation['member']];
        }

        for await (const member of memberList) {
          const attr = member['_attributes'];
          const type = attr['type'];
          const role = attr['role'];

          if (type === 'way') {
            const wayId = attr['ref'];
            const geometry = ways[wayId];
            const item = {
              relation: relationId,
              way: wayId,
              role: role,
              geometry: geometry
            };
            result.push(item);
          }
        }
      }
    }

    return result;
  }

}

OSM.api = _axios.default.create({
  baseURL: 'https://www.openstreetmap.org/api/0.6',
  headers: {
    'User-Agent': 'Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; 360SE)'
  }
});
var _default = OSM;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tb2R1bGVzL09TTS9pbmRleC5qcyJdLCJuYW1lcyI6WyJPU00iLCJnZXRDb3VudHJ5VHJlZSIsIkNvdW50cnlUcmVlIiwicmVsYXRpb25GdWxsIiwib3NtSWRzIiwicmVsYXRpb25zIiwib3NtSWQiLCJVdGlscyIsImxvZyIsImFwaSIsImdldCIsInRoZW4iLCJyZXMiLCJ4bWwiLCJkYXRhIiwiWG1sSnMiLCJ4bWwyanMiLCJjb21wYWN0IiwicmVsYXRpb25XYXlzIiwib3NtWG1sT2JqIiwibm9kZUxpc3QiLCJub2RlcyIsIm5vZGUiLCJhdHRyIiwibGF0IiwibG9uIiwibm9kZUlkIiwid2F5TGlzdCIsIkFycmF5IiwiaXNBcnJheSIsIndheXMiLCJ3YXkiLCJ3YXlJZCIsIm5kcyIsImxpbmVTdHJpbmciLCJuZCIsIm5kSWQiLCJwdXNoIiwidHlwZSIsImNvb3JkaW5hdGVzIiwicmVzdWx0IiwicmVsYXRpb25MaXN0IiwicmVsYXRpb24iLCJyZWxhdGlvbklkIiwibWVtYmVyTGlzdCIsIm1lbWJlciIsInJvbGUiLCJnZW9tZXRyeSIsIml0ZW0iLCJBeGlvcyIsImNyZWF0ZSIsImJhc2VVUkwiLCJoZWFkZXJzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUVBOzs7O0FBRUEsTUFBTUEsR0FBTixDQUFVO0FBU1IsU0FBT0MsY0FBUCxHQUF3QjtBQUN0QixXQUFPQyxvQkFBUDtBQUNEOztBQUVELGVBQWFDLFlBQWIsQ0FBMEJDLE1BQTFCLEVBQWtDO0FBQ2hDLFVBQU1DLFNBQVMsR0FBRyxFQUFsQjs7QUFDQSxlQUFXLE1BQU1DLEtBQWpCLElBQTBCRixNQUExQixFQUFrQztBQUNoQyxZQUFNRyxlQUFNQyxHQUFOLENBQVcsa0RBQWlERixLQUFNLE9BQWxFLENBQU47QUFDQUQsTUFBQUEsU0FBUyxDQUFDQyxLQUFELENBQVQsR0FBbUIsTUFBTSxLQUFLRyxHQUFMLENBQVNDLEdBQVQsQ0FBYyxhQUFZ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QVlXLElBQVo7QUFDRDtBQUNGO0FBQ0Y7QUFDRjs7QUFDRCxXQUFPUixNQUFQO0FBQ0Q7O0FBekdPOztBQUFKeEMsRyxDQUVHUyxHLEdBQU13QyxlQUFNQyxNQUFOLENBQWE7QUFDeEJDLEVBQUFBLE9BQU8sRUFBRSx1Q0FEZTtBQUV4QkMsRUFBQUEsT0FBTyxFQUFFO0FBQ1Asa0JBQWM7QUFEUDtBQUZlLENBQWIsQztlQTRHQXBELEciLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCBBeGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQgWG1sSnMgZnJvbSAneG1sLWpzJztcbmltcG9ydCBVdGlscyBmcm9tICcuLy4uL1V0aWxzJztcblxuaW1wb3J0IENvdW50cnlUcmVlIGZyb20gJy4vQ291bnRyeVRyZWUnO1xuXG5jbGFzcyBPU00ge1xuXG4gIHN0YXRpYyBhcGkgPSBBeGlvcy5jcmVhdGUoe1xuICAgIGJhc2VVUkw6ICdodHRwczovL3d3dy5vcGVuc3RyZWV0bWFwLm9yZy9hcGkvMC42JyxcbiAgICBoZWFkZXJzOiB7XG4gICAgICAnVXNlci1BZ2VudCc6ICdNb3ppbGxhLzQuMCAoY29tcGF0aWJsZTsgTVNJRSA3LjA7IFdpbmRvd3MgTlQgNS4xOyAzNjBTRSknXG4gICAgfVxuICB9KTtcblxuICBzdGF0aWMgZ2V0Q291bnRyeVRyZWUoKSB7XG4gICAgcmV0dXJuIENvdW50cnlUcmVlO1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIHJlbGF0aW9uRnVsbChvc21JZHMpIHtcbiAgICBjb25zdCByZWxhdGlvbnMgPSB7fTtcbiAgICBmb3IgYXdhaXQgKGNvbnN0IG9zbUlkIG9mIG9zbUlkcykge1xuICAgICAgYXdhaXQgVXRpbHMubG9nKGBodHRwczovL3d3dy5vcGVuc3RyZWV0bWFwLm9yZy9hcGkvMC42L3JlbGF0aW9uLyR7b3NtSWR9L2Z1bGxgKTtcbiAgICAgIHJlbGF0aW9uc1tvc21JZF0gPSBhd2FpdCB0aGlzLmFwaS5nZXQoYC9yZWxhdGlvbi8ke29zbUlkfS9mdWxsYClcbiAgICAgICAgLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICBjb25zdCB4bWwgPSByZXMuZGF0YTtcbiAgICAgICAgICByZXR1cm4gWG1sSnMueG1sMmpzKHhtbCwge1xuICAgICAgICAgICAgY29tcGFjdDogdHJ1ZVxuICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgICAgO1xuICAgIH1cbiAgICByZXR1cm4gcmVsYXRpb25zO1xuICB9XG5cblxuICBzdGF0aWMgYXN5bmMgcmVsYXRpb25XYXlzKG9zbUlkLCBvc21YbWxPYmopIHtcbiAgICBjb25zdCBub2RlTGlzdCA9IG9zbVhtbE9ialsnb3NtJ11bJ25vZGUnXTtcbiAgICBjb25zdCBub2RlcyA9IHt9O1xuICAgIGZvciBhd2FpdCAoY29uc3Qgbm9kZSBvZiBub2RlTGlzdCkge1xuICAgICAgY29uc3QgYXR0ciA9IG5vZGVbJ19hdHRyaWJ1dGVzJ107XG4gICAgICBjb25zdCBsYXQgPSArYXR0clsnbGF0J107XG4gICAgICBjb25zdCBsb24gPSArYXR0clsnbG9uJ107XG4gICAgICBjb25zdCBub2RlSWQgPSArYXR0clsnaWQnXTtcbiAgICAgIGlmICghbm9kZXNbbm9kZUlkXSkge1xuICAgICAgICBub2Rlc1tub2RlSWRdID0ge1xuICAgICAgICAgIGxhdCwgbG9uXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IHdheUxpc3Q7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkob3NtWG1sT2JqWydvc20nXVsnd2F5J10pKSB7XG4gICAgICB3YXlMaXN0ID0gb3NtWG1sT2JqWydvc20nXVsnd2F5J107XG4gICAgfSBlbHNlIHtcbiAgICAgIHdheUxpc3QgPSBbb3NtWG1sT2JqWydvc20nXVsnd2F5J11dO1xuICAgIH1cbiAgICBjb25zdCB3YXlzID0ge307XG4gICAgZm9yIGF3YWl0IChjb25zdCB3YXkgb2Ygd2F5TGlzdCkge1xuICAgICAgY29uc3QgYXR0ciA9IHdheVsnX2F0dHJpYnV0ZXMnXTtcbiAgICAgIGNvbnN0IHdheUlkID0gK2F0dHJbJ2lkJ107XG4gICAgICBjb25zdCBuZHMgPSB3YXlbJ25kJ107XG4gICAgICBjb25zdCBsaW5lU3RyaW5nID0gW107XG4gICAgICBmb3IgYXdhaXQgKGNvbnN0IG5kIG9mIG5kcykge1xuICAgICAgICBjb25zdCBuZElkID0gbmRbJ19hdHRyaWJ1dGVzJ11bJ3JlZiddO1xuICAgICAgICBjb25zdCBub2RlID0gbm9kZXNbbmRJZF0gfHwge307XG4gICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgbGluZVN0cmluZy5wdXNoKFtub2RlLmxvbiwgbm9kZS5sYXRdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgd2F5c1t3YXlJZF0gPSB7XG4gICAgICAgIHR5cGU6ICdMaW5lU3RyaW5nJyxcbiAgICAgICAgY29vcmRpbmF0ZXM6IGxpbmVTdHJpbmdcbiAgICAgIH07XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xuICAgIGxldCByZWxhdGlvbkxpc3Q7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkob3NtWG1sT2JqWydvc20nXVsncmVsYXRpb24nXSkpIHtcbiAgICAgIHJlbGF0aW9uTGlzdCA9IG9zbVhtbE9ialsnb3NtJ11bJ3JlbGF0aW9uJ107XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlbGF0aW9uTGlzdCA9IFtvc21YbWxPYmpbJ29zbSddWydyZWxhdGlvbiddXTtcbiAgICB9XG4gICAgZm9yIGF3YWl0IChjb25zdCByZWxhdGlvbiBvZiByZWxhdGlvbkxpc3QpIHtcbiAgICAgIGNvbnN0IGF0dHIgPSByZWxhdGlvblsnX2F0dHJpYnV0ZXMnXTtcbiAgICAgIGNvbnN0IHJlbGF0aW9uSWQgPSArYXR0clsnaWQnXTtcbiAgICAgIGlmIChyZWxhdGlvbklkID09PSArb3NtSWQpIHtcbiAgICAgICAgbGV0IG1lbWJlckxpc3Q7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlbGF0aW9uWydtZW1iZXInXSkpIHtcbiAgICAgICAgICBtZW1iZXJMaXN0ID0gcmVsYXRpb25bJ21lbWJlciddO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG1lbWJlckxpc3QgPSBbcmVsYXRpb25bJ21lbWJlciddXTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IG1lbWJlciBvZiBtZW1iZXJMaXN0KSB7XG4gICAgICAgICAgY29uc3QgYXR0ciA9IG1lbWJlclsnX2F0dHJpYnV0ZXMnXTtcbiAgICAgICAgICBjb25zdCB0eXBlID0gYXR0clsndHlwZSddO1xuICAgICAgICAgIGNvbnN0IHJvbGUgPSBhdHRyWydyb2xlJ107XG4gICAgICAgICAgaWYgKHR5cGUgPT09ICd3YXknKSB7XG4gICAgICAgICAgICBjb25zdCB3YXlJZCA9IGF0dHJbJ3JlZiddO1xuICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSB3YXlzW3dheUlkXTtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB7XG4gICAgICAgICAgICAgIHJlbGF0aW9uOiByZWxhdGlvbklkLFxuICAgICAgICAgICAgICB3YXk6IHdheUlkLFxuICAgICAgICAgICAgICByb2xlOiByb2xlLFxuICAgICAgICAgICAgICBnZW9tZXRyeTogZ2VvbWV0cnksXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goaXRlbSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbn1cblxuXG5cbmV4cG9ydCBkZWZhdWx0IE9TTTsiXX0=